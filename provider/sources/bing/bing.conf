# Autogenerated
location /source/bing {
    rewrite_by_lua_block {
        function XYZToQuadKey(x,y,z)
            local quadkey = ''
            local i = z

            for i = z, 1, -1 do
                digit = 0
                mask = 1 << (i - 1)

                if(x & mask ~= 0) then
                    digit = digit + 1
                end
                if(y & mask ~= 0) then
                    digit = digit + 2
                end

                quadkey = quadkey .. tostring(digit)
            end

            return quadkey
        end

        local subdomainMap = {
            a: '0',
            b: '1',
            c: '2'
        }

        local captures, err = ngx.re.match(ngx.var.request_uri, '^/source/bing/(?<sw>[abc])/(?<z>\d+)/(?<x>\d+)/(?<y>\d+)$')

        local subdomain = subdomainMap[captures['sw']]

        local newUrl = string.format('https://ecn.t%1.tiles.virtualearth.net/tiles/a%2.jpeg?g=587&n=z', subdomain, XYZToQuadKey(captures['x'], captures['y'], captures['z']))
        return ngx.redirect(newUrl, 301)
    }
}
